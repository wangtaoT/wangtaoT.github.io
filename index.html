<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangtaot.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="技术分享">
<meta property="og:type" content="website">
<meta property="og:title" content="Wangtao&#39;s Blog">
<meta property="og:url" content="http://wangtaot.github.io/index.html">
<meta property="og:site_name" content="Wangtao&#39;s Blog">
<meta property="og:description" content="技术分享">
<meta property="og:locale">
<meta property="article:author" content="wangtao">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://wangtaot.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Wangtao's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GH7RKS5K0L"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GH7RKS5K0L","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Wangtao's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Android Developer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wangtao</p>
  <div class="site-description" itemprop="description">技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2023/09/04/Android-%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2%E6%A1%8C%E9%9D%A2%E5%9B%BE%E6%A0%87-ICON/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/04/Android-%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2%E6%A1%8C%E9%9D%A2%E5%9B%BE%E6%A0%87-ICON/" class="post-title-link" itemprop="url">Android 动态切换桌面图标 ICON</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-04 10:45:59" itemprop="dateCreated datePublished" datetime="2023-09-04T10:45:59+08:00">2023-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>谷歌认为，图标变更功能应该使用独立的LAUNCHER Activity实现，而不应借助activity-alias。<br>最建议方案如下：</p>
<h3 id="1-新建-NewMainActivity"><a href="#1-新建-NewMainActivity" class="headerlink" title="1. 新建 NewMainActivity()"></a>1. 新建 NewMainActivity()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NewMainActivity</span> : <span class="type">MainActivity</span>()</span><br></pre></td></tr></table></figure>

<h3 id="2-配置-AndroidManifest-xml"><a href="#2-配置-AndroidManifest-xml" class="headerlink" title="2. 配置 AndroidManifest.xml"></a>2. 配置 AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:targetActivity</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.NewMainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher_show&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:targetActivity</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-MainActivity-中切换代码"><a href="#3-MainActivity-中切换代码" class="headerlink" title="3. MainActivity() 中切换代码"></a>3. MainActivity() 中切换代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">open <span class="keyword">class</span> <span class="title class_">MainActivity</span> : AppCompatActivity() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">var</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    override fun <span class="title function_">onCreate</span><span class="params">(savedInstanceState: Bundle?)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        findViewById&lt;View&gt;(R.id.btn_default).setOnClickListener &#123;</span><br><span class="line">            position = <span class="number">0</span></span><br><span class="line"><span class="comment">//            setDefaultAlias()</span></span><br><span class="line">            Toast.makeText(<span class="built_in">this</span><span class="meta">@MainActivity</span>, <span class="string">&quot;退到后台后切换&quot;</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">        &#125;</span><br><span class="line">        findViewById&lt;View&gt;(R.id.btn_alias1).setOnClickListener &#123;</span><br><span class="line">            position = <span class="number">1</span></span><br><span class="line"><span class="comment">//            setAlias1()</span></span><br><span class="line">            Toast.makeText(<span class="built_in">this</span><span class="meta">@MainActivity</span>, <span class="string">&quot;退到后台后切换&quot;</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ProcessLifecycleOwner.get().lifecycle.addObserver(object : LifecycleEventObserver &#123;</span><br><span class="line">            override fun <span class="title function_">onStateChanged</span><span class="params">(source: LifecycleOwner, event: Lifecycle.Event)</span> &#123;</span><br><span class="line">                when (event) &#123;</span><br><span class="line">                    Lifecycle.Event.ON_RESUME -&gt; &#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Lifecycle.Event.ON_START -&gt; &#123;</span><br><span class="line">                        Log.i(<span class="string">&quot;LifecycleObserver&quot;</span>, <span class="string">&quot;应用回到前台&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Lifecycle.Event.ON_STOP -&gt; &#123;</span><br><span class="line">                        Log.i(<span class="string">&quot;LifecycleObserver&quot;</span>, <span class="string">&quot;应用退到后台&quot;</span>)</span><br><span class="line">                        <span class="comment">//根据具体业务需求设置切换条件,我公司采用接口控制icon切换</span></span><br><span class="line">                        <span class="keyword">if</span> (position == <span class="number">0</span>) &#123;</span><br><span class="line">                            setDefaultAlias()</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            setAlias1()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">else</span> -&gt; &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置默认的别名为启动入口</span></span><br><span class="line"><span class="comment">     * 在设置图标不可见的方法中，我们传递的是 PackageManager.DONT_KILL_APP ，在设置图标可见的方法中我们传递的是 0 。传递0表示会杀死包含该组件的app，桌面图标立即会更改掉。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fun <span class="title function_">setDefaultAlias</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">packageManager</span> <span class="operator">=</span> packageManager</span><br><span class="line">        <span class="type">val</span> <span class="variable">name2</span> <span class="operator">=</span> ComponentName(<span class="built_in">this</span>, NewMainActivity::class.java)</span><br><span class="line">        packageManager.setComponentEnabledSetting(</span><br><span class="line">            name2,</span><br><span class="line">            PackageManager.COMPONENT_ENABLED_STATE_DISABLED,</span><br><span class="line">            PackageManager.DONT_KILL_APP</span><br><span class="line">        )</span><br><span class="line">        <span class="type">val</span> <span class="variable">name1</span> <span class="operator">=</span> ComponentName(<span class="built_in">this</span>, MainActivity::class.java)</span><br><span class="line">        packageManager.setComponentEnabledSetting(</span><br><span class="line">            name1,</span><br><span class="line">            PackageManager.COMPONENT_ENABLED_STATE_ENABLED,</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置别名1为启动入口</span></span><br><span class="line"><span class="comment">     * 在设置图标不可见的方法中，我们传递的是 PackageManager.DONT_KILL_APP ，在设置图标可见的方法中我们传递的是 0 。传递0表示会杀死包含该组件的app，桌面图标立即会更改掉。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fun <span class="title function_">setAlias1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">packageManager</span> <span class="operator">=</span> packageManager</span><br><span class="line">        <span class="type">val</span> <span class="variable">name1</span> <span class="operator">=</span> ComponentName(<span class="built_in">this</span>, MainActivity::class.java)</span><br><span class="line">        packageManager.setComponentEnabledSetting(</span><br><span class="line">            name1,</span><br><span class="line">            PackageManager.COMPONENT_ENABLED_STATE_DISABLED,</span><br><span class="line">            PackageManager.DONT_KILL_APP</span><br><span class="line">        )</span><br><span class="line">        <span class="type">val</span> <span class="variable">name2</span> <span class="operator">=</span> ComponentName(<span class="built_in">this</span>, NewMainActivity::class.java)</span><br><span class="line">        packageManager.setComponentEnabledSetting(</span><br><span class="line">            name2,</span><br><span class="line">            PackageManager.COMPONENT_ENABLED_STATE_ENABLED,</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-参考资料"><a href="#4-参考资料" class="headerlink" title="4. 参考资料"></a>4. 参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c380f54e71bf">https://www.jianshu.com/p/c380f54e71bf</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2020/11/09/ffmpeg%E6%8F%92%E5%85%A5sei%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/09/ffmpeg%E6%8F%92%E5%85%A5sei%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">ffmpeg插入sei实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-11-09 14:00:18" itemprop="dateCreated datePublished" datetime="2020-11-09T14:00:18+08:00">2020-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文章主要讲述如何修改ffmpeg源码，实现在每个关键帧中插入sei。</p>
<h2 id="原始Bsf"><a href="#原始Bsf" class="headerlink" title="原始Bsf"></a>原始Bsf</h2><p>BitStream Filter（码流过滤）的缩写为bsf，它的作用是，在不做码流解码的前提下，对已经编码后的比特流做特定的修改、调整。</p>
<p>bsf h264_metadata的调用</p>
<p>使用ffmpeg工具时，可以使用比特流过滤器。基本的filter调用格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i INPUT -c:v copy -bsf:v filter1[=opt1=str1:opt2=str2][,filter2] OUTPUT</span><br></pre></td></tr></table></figure>

<p>可以使用 h264_metadata比特流过滤器添加SEI。下面示例命令添加了类型为未注册的用户数据的SEI，其中uuid为”086f3693-b7b3-4f2c-9653-21492feee5b8”，payload内容为”hello”：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ffmpeg  -I oceans.h264 -c:v copy -bsf:v h264_metadata=sei_user_data=&#x27;086f3693-b7b3-4f2c-9653-21492feee5b8+hello&#x27; oceans.sei.h264</span><br></pre></td></tr></table></figure>

<h2 id="Bsf修改"><a href="#Bsf修改" class="headerlink" title="Bsf修改"></a>Bsf修改</h2><p>修改文件为<a target="_blank" rel="noopener" href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/h264_metadata_bsf.c">h264_metadata_bsf.c</a></p>
<h4 id="查找出关键帧"><a href="#查找出关键帧" class="headerlink" title="查找出关键帧"></a>查找出关键帧</h4><p>from</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">has_sps = 0;</span><br><span class="line">for (i = 0; i &lt; au-&gt;nb_units; i++) &#123;</span><br><span class="line">    if (au-&gt;units[i].type == H264_NAL_SPS) &#123;</span><br><span class="line">        err = h264_metadata_update_sps(bsf, au-&gt;units[i].content);</span><br><span class="line">        if (err &lt; 0)</span><br><span class="line">            goto fail;</span><br><span class="line">        has_sps = 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>to</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int has_idr = 0;</span><br><span class="line">has_sps = 0;</span><br><span class="line">for (i = 0; i &lt; au-&gt;nb_units; i++) &#123;</span><br><span class="line">    if (au-&gt;units[i].type == H264_NAL_SPS) &#123;</span><br><span class="line">        err = h264_metadata_update_sps(bsf, au-&gt;units[i].content);</span><br><span class="line">        if (err &lt; 0)</span><br><span class="line">            goto fail;</span><br><span class="line">        has_sps = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    if (au-&gt;units[i].type == H264_NAL_IDR_SLICE) &#123;</span><br><span class="line">        has_idr = 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="判断是关键帧"><a href="#判断是关键帧" class="headerlink" title="判断是关键帧"></a>判断是关键帧</h4><p>from</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Only insert the SEI in access units containing SPSs, and also</span><br><span class="line">// unconditionally in the first access unit we ever see.</span><br><span class="line">if (ctx-&gt;sei_user_data &amp;&amp; (has_sps || !ctx-&gt;done_first_au)) &#123;</span><br></pre></td></tr></table></figure>
<p>to</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Only insert the SEI in access units containing IDRs, and also</span><br><span class="line">// unconditionally in the first access unit we ever see.</span><br><span class="line">if (ctx-&gt;sei_user_data &amp;&amp; (has_idr || !ctx-&gt;done_first_au)) &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="在关键帧后插入一帧SEI"><a href="#在关键帧后插入一帧SEI" class="headerlink" title="在关键帧后插入一帧SEI"></a>在关键帧后插入一帧SEI</h4><p>当参数为“**-bsf:v h264_metadata&#x3D;sei_user_data&#x3D;’086f3693-b7b3-4f2c-9653-21492feee5b8+{timestamp}’**”时插入当前时间戳。</p>
<p>解析出的SEI信息为”ts:timestamp”精确到毫秒</p>
<p>from</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">udu-&gt;data        = udu-&gt;data_ref-&gt;data;</span><br><span class="line">udu-&gt;data_length = len + 1;</span><br><span class="line">memcpy(udu-&gt;data, ctx-&gt;sei_user_data + i + 1, len + 1);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>to</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">udu-&gt;data        = udu-&gt;data_ref-&gt;data;</span><br><span class="line">udu-&gt;data_length = len + 1;</span><br><span class="line">memcpy(udu-&gt;data, ctx-&gt;sei_user_data + i + 1, len + 1);</span><br><span class="line">        </span><br><span class="line">//convert to Timestamp</span><br><span class="line">if(strcmp(udu-&gt;data, &quot;&#123;timestamp&#125;&quot;) == 0)&#123;</span><br><span class="line">    char mark[] = &quot;ts:&quot;;</span><br><span class="line">    long timestamp = av_gettime() / 1000;</span><br><span class="line">    char result[20];</span><br><span class="line">    sprintf(result, &quot;%s%ld&quot;, mark, timestamp);</span><br><span class="line">            </span><br><span class="line">    udu-&gt;data        = result;</span><br><span class="line">    udu-&gt;data_length = strlen(result) + 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h3><p>使用xcode</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/226c19aa6e42">https://www.jianshu.com/p/226c19aa6e42</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.f-fox.com/2019/03/06/%E4%BD%BF%E7%94%A8Xcode%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95ffmpeg/">https://blog.f-fox.com/2019/03/06/%E4%BD%BF%E7%94%A8Xcode%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95ffmpeg/</a></li>
</ul>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-bsf:v h264_metadata=sei_user_data=&#x27;086f3693-b7b3-4f2c-9653-21492feee5b8+&#123;timestamp&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>栗子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-stream_loop -1 -i video.mp4  -c:a aac -c:v libx264 -bsf:v h264_metadata=sei_user_data=&#x27;086f3693-b7b3-4f2c-9653-21492feee5b8+&#123;timestamp&#125;&#x27; -f flv rtmp://demo-push.cn/live/11</span><br></pre></td></tr></table></figure>


<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TePsSvMgGDlZ9RgUkqFJ3A">https://mp.weixin.qq.com/s/TePsSvMgGDlZ9RgUkqFJ3A</a></li>
<li><a target="_blank" rel="noopener" href="http://bbs.chinaffmpeg.com/forum.php?mod=viewthread&tid=589&fromuid=3">http://bbs.chinaffmpeg.com/forum.php?mod=viewthread&amp;tid=589&amp;fromuid=3</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2020/06/03/Android%E6%8E%A8%E6%B5%81rtmp%E6%8F%92%E5%85%A5SEI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/03/Android%E6%8E%A8%E6%B5%81rtmp%E6%8F%92%E5%85%A5SEI/" class="post-title-link" itemprop="url">Android推流rtmp插入SEI</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-06-03 17:38:37" itemprop="dateCreated datePublished" datetime="2020-06-03T17:38:37+08:00">2020-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Android-MediaCodec编码-推流rtmp-插入SEI"><a href="#Android-MediaCodec编码-推流rtmp-插入SEI" class="headerlink" title="Android MediaCodec编码 推流rtmp 插入SEI"></a>Android MediaCodec编码 推流rtmp 插入SEI</h2><h3 id="该插入SEI方法，可用于开源项目yasea-rtmp-rtsp-stream-client-java"><a href="#该插入SEI方法，可用于开源项目yasea-rtmp-rtsp-stream-client-java" class="headerlink" title="该插入SEI方法，可用于开源项目yasea &amp; rtmp-rtsp-stream-client-java"></a>该插入SEI方法，可用于开源项目<a target="_blank" rel="noopener" href="https://github.com/begeekmyfriend/yasea">yasea</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/pedroSG94/rtmp-rtsp-stream-client-java">rtmp-rtsp-stream-client-java</a></h3><blockquote>
<p>当前项封装成flv进行推流。所以要在flv中插入SEI自定义信息<br>当前实现的是在每个关键帧中插入SEI时间戳（也可插入其他自定义信息）</p>
</blockquote>
<h4 id="修改文件为yasea-SrsFlvMuxer-java-rtmp-rtsp-stream-client-java-SrsFlvMuxer-java"><a href="#修改文件为yasea-SrsFlvMuxer-java-rtmp-rtsp-stream-client-java-SrsFlvMuxer-java" class="headerlink" title="修改文件为yasea-&gt;SrsFlvMuxer.java&amp;rtmp-rtsp-stream-client-java-&gt;SrsFlvMuxer.java"></a>修改文件为<a target="_blank" rel="noopener" href="https://github.com/begeekmyfriend/yasea/blob/master/library/src/main/java/net/ossrs/yasea/SrsFlvMuxer.java#L876">yasea-&gt;SrsFlvMuxer.java</a>&amp;<a target="_blank" rel="noopener" href="https://github.com/pedroSG94/rtmp-rtsp-stream-client-java/blob/master/rtmp/src/main/java/net/ossrs/rtmp/SrsFlvMuxer.java#L935">rtmp-rtsp-stream-client-java-&gt;SrsFlvMuxer.java</a></h4><p>修改的代码段如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public void writeVideoSample(final ByteBuffer bb, MediaCodec.BufferInfo bi) &#123;</span><br><span class="line">            if (bi.size &lt; 4) return;</span><br><span class="line"></span><br><span class="line">            long pts = (int) (bi.presentationTimeUs / 1000);</span><br><span class="line">            long dts = pts;</span><br><span class="line">            int type = SrsCodecVideoAVCFrame.InterFrame;</span><br><span class="line">            SrsFlvFrameBytes frame = avc.demuxAnnexb(bb, bi, true);</span><br><span class="line">            int nal_unit_type = frame.data.get(0) &amp; 0x1f;</span><br><span class="line">            if (nal_unit_type == SrsAvcNaluType.IDR || bi.flags == MediaCodec.BUFFER_FLAG_KEY_FRAME) &#123;</span><br><span class="line">                type = SrsCodecVideoAVCFrame.KeyFrame;</span><br><span class="line"></span><br><span class="line">		         //增加代码如下</span><br><span class="line">                ByteBuffer sei = ByteBuffer.wrap(muxSEI(System.currentTimeMillis()+&quot;&quot;));</span><br><span class="line">                SrsFlvFrameBytes frameSei = new SrsFlvFrameBytes();</span><br><span class="line">                frameSei.size = sei.array().length;</span><br><span class="line">                frameSei.data = sei.duplicate();</span><br><span class="line"></span><br><span class="line">                ipbs.add(avc.muxNaluHeader(frameSei));</span><br><span class="line">                ipbs.add(frameSei);</span><br><span class="line">                //增加代码如上</span><br><span class="line">            &#125; else if (nal_unit_type == SrsAvcNaluType.SPS || nal_unit_type == SrsAvcNaluType.PPS) &#123;</span><br><span class="line">                SrsFlvFrameBytes frame_pps = avc.demuxAnnexb(bb, bi, false);</span><br><span class="line">                frame.size = frame.size - frame_pps.size - 4;  // 4 ---&gt; 00 00 00 01 pps</span><br><span class="line">                if (!frame.data.equals(h264_sps)) &#123;</span><br><span class="line">                    byte[] sps = new byte[frame.size];</span><br><span class="line">                    frame.data.get(sps);</span><br><span class="line">                    isPpsSpsSend = false;</span><br><span class="line">                    h264_sps = ByteBuffer.wrap(sps);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                SrsFlvFrameBytes frame_sei = avc.demuxAnnexb(bb, bi, false);</span><br><span class="line">                if (frame_sei.size &gt; 0) &#123;</span><br><span class="line">                    if (SrsAvcNaluType.SEI == (frame_sei.data.get(0) &amp; 0x1f)) &#123;</span><br><span class="line">                        frame_pps.size = frame_pps.size - frame_sei.size - 3;// 3 ---&gt; 00 00 01 SEI</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (frame_pps.size &gt; 0 &amp;&amp; !frame_pps.data.equals(h264_pps)) &#123;</span><br><span class="line">                    byte[] pps = new byte[frame_pps.size];</span><br><span class="line">                    frame_pps.data.get(pps);</span><br><span class="line">                    isPpsSpsSend = false;</span><br><span class="line">                    h264_pps = ByteBuffer.wrap(pps);</span><br><span class="line">                    writeH264SpsPps(dts, pts);</span><br><span class="line">                &#125;</span><br><span class="line">                return;</span><br><span class="line">            &#125; else if (nal_unit_type != SrsAvcNaluType.NonIDR) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ipbs.add(avc.muxNaluHeader(frame));</span><br><span class="line">            ipbs.add(frame);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            writeH264IpbFrame(ipbs, type, dts, pts);</span><br><span class="line">            ipbs.clear();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="新增的muxSEI方法"><a href="#新增的muxSEI方法" class="headerlink" title="新增的muxSEI方法"></a>新增的muxSEI方法</h4><blockquote>
<p>该方法实现的是SEI的组装</p>
</blockquote>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">private byte[] muxSEI(String msg) &#123;</span><br><span class="line">       byte[] seiContent = msg.getBytes();</span><br><span class="line">       byte[] seiType = new byte[]&#123;0x06, 0x05&#125;;</span><br><span class="line">       byte[] seiUuid = new byte[]&#123;</span><br><span class="line">               0x01, 0x02, 0x03, 0x04, 0x01, 0x02, 0x03, 0x04,</span><br><span class="line">               0x01, 0x02, 0x03, 0x04, 0x01, 0x02, 0x03, 0x04&#125;;</span><br><span class="line">       byte[] seiEnd = new byte[]&#123;(byte) 0x80&#125;;</span><br><span class="line">       int contentSize = 16 + seiContent.length;</span><br><span class="line"></span><br><span class="line">       //数据长度(数据长度减去255，有多少个就写多少个FF，剩下的不为0，再写一个字节)</span><br><span class="line">       int ffCount = 0;</span><br><span class="line">       while (true) &#123;</span><br><span class="line">           if (contentSize &gt;= 255) &#123;</span><br><span class="line">               ffCount++;</span><br><span class="line">           &#125;</span><br><span class="line">           if (contentSize &lt; 255) &#123;</span><br><span class="line">               break;</span><br><span class="line">           &#125;</span><br><span class="line">           contentSize -= 255;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       String size = Integer.toHexString(contentSize);</span><br><span class="line">       byte[] contentLastSize = Hex.decodeHex(size);</span><br><span class="line">       byte[] contentFirstSize = new byte[ffCount];</span><br><span class="line">       for (int i = 0; i &lt; ffCount; i++) &#123;</span><br><span class="line">           contentFirstSize[i] = (byte) 0xff;</span><br><span class="line">       &#125;</span><br><span class="line">       byte[] sei_content_size = combineArrays(contentFirstSize, contentLastSize);</span><br><span class="line"></span><br><span class="line">       return combineArrays(seiType, sei_content_size, seiUuid, seiContent, seiEnd);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private byte[] combineArrays(byte[]... a) &#123;</span><br><span class="line">       int massLength = 0;</span><br><span class="line">       for (byte[] b : a) &#123;</span><br><span class="line">           massLength += b.length;</span><br><span class="line">       &#125;</span><br><span class="line">       byte[] c = new byte[massLength];</span><br><span class="line">       byte[] d;</span><br><span class="line">       int index = 0;</span><br><span class="line">       for (byte[] anA : a) &#123;</span><br><span class="line">           d = anA;</span><br><span class="line">           System.arraycopy(d, 0, c, 0 + index, d.length);</span><br><span class="line">           index += d.length;</span><br><span class="line">       &#125;</span><br><span class="line">       return c;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="h264-SEI原理"><a href="#h264-SEI原理" class="headerlink" title="h264 SEI原理"></a>h264 SEI原理</h4><blockquote>
<p> 大家可参考该链接<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7c6861f0d7fd">https://www.jianshu.com/p/7c6861f0d7fd</a></p>
</blockquote>
<h4 id="flv封装原理"><a href="#flv封装原理" class="headerlink" title="flv封装原理"></a>flv封装原理</h4><blockquote>
<p>可参考该链接<a target="_blank" rel="noopener" href="https://blog.evanxia.com/2017/07/1378">https://blog.evanxia.com/2017/07/1378</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2020/03/27/%E6%8E%A5%E6%94%B6%E5%BE%AE%E4%BF%A1%E3%80%81QQ%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E6%89%93%E5%BC%80%EF%BC%8C%E7%AC%AC%E4%B8%89%E6%96%B9%E5%88%86%E4%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/03/27/%E6%8E%A5%E6%94%B6%E5%BE%AE%E4%BF%A1%E3%80%81QQ%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E6%89%93%E5%BC%80%EF%BC%8C%E7%AC%AC%E4%B8%89%E6%96%B9%E5%88%86%E4%BA%AB/" class="post-title-link" itemprop="url">Android接收微信、QQ其他应用打开，第三方分享</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-03-27 10:40:41" itemprop="dateCreated datePublished" datetime="2020-03-27T10:40:41+08:00">2020-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="在AndroidManifest-xml注册ACTION事件"><a href="#在AndroidManifest-xml注册ACTION事件" class="headerlink" title="在AndroidManifest.xml注册ACTION事件"></a>在AndroidManifest.xml注册ACTION事件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">        android:name=&quot;com.test.app.MainActivity&quot;</span><br><span class="line">        android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot;</span><br><span class="line">        android:label=&quot;这里的名称会对外显示&quot;</span><br><span class="line">        android:launchMode=&quot;singleTask&quot;</span><br><span class="line">        android:screenOrientation=&quot;portrait&quot;&gt;</span><br><span class="line">        //注册接收分享</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">            &lt;action android:name=&quot;android.intent.action.SEND&quot; /&gt;</span><br><span class="line">            &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;</span><br><span class="line"></span><br><span class="line">            //接收分享的文件类型</span><br><span class="line">            &lt;data android:mimeType=&quot;image/*&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/msword&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.ms-excel&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.ms-powerpoint&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/pdf&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;text/plain&quot; /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">            </span><br><span class="line">        //注册默认打开事件，微信、QQ的其他应用打开</span><br><span class="line">        &lt;intent-filter&gt;</span><br><span class="line">            &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;</span><br><span class="line">            &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;</span><br><span class="line">            </span><br><span class="line">            //接收打开的文件类型</span><br><span class="line">            &lt;data android:scheme=&quot;file&quot; /&gt;</span><br><span class="line">            &lt;data android:scheme=&quot;content&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;image/*&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/msword&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.ms-excel&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.ms-powerpoint&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;application/pdf&quot; /&gt;</span><br><span class="line">            &lt;data android:mimeType=&quot;text/plain&quot; /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">        &lt;/activity&gt;</span><br></pre></td></tr></table></figure>

<h3 id="在用于接收分享的Activity里面加接收代码"><a href="#在用于接收分享的Activity里面加接收代码" class="headerlink" title="在用于接收分享的Activity里面加接收代码"></a>在用于接收分享的Activity里面加接收代码</h3><ol>
<li>当APP进程在后台时，会调用Activity的onNewIntent方法</li>
<li>当APP进程被杀死时，会调用onCreate方法</li>
</ol>
<blockquote>
<p>所以在两个方法中都需要监听事件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">    super.onCreate(savedInstanceState);</span><br><span class="line">    receiveActionSend(intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected void onNewIntent(Intent intent) &#123;</span><br><span class="line">    super.onNewIntent(intent);</span><br><span class="line">    receiveActionSend(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>receiveActionSend方法如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public void receiveActionSend(Intent intent) &#123;</span><br><span class="line">    String action = intent.getAction();</span><br><span class="line">    String type = intent.getType();</span><br><span class="line"></span><br><span class="line">    //判断action事件</span><br><span class="line">    if (type == null || (!Intent.ACTION_VIEW.equals(action) &amp;&amp; !Intent.ACTION_SEND.equals(action))) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //取出文件uri</span><br><span class="line">    Uri uri = intent.getData();</span><br><span class="line">    if (uri == null) &#123;</span><br><span class="line">        uri = intent.getParcelableExtra(Intent.EXTRA_STREAM);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //获取文件真实地址</span><br><span class="line">    String filePath = UriUtils.getFileFromUri(EdusohoApp.baseApp, uri);</span><br><span class="line">    if (TextUtils.isEmpty(filePath)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //业务处理</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取真实路径getFileFromUri方法</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取真实路径</span><br><span class="line"> *</span><br><span class="line"> * @param context</span><br><span class="line"> */</span><br><span class="line">public static String getFileFromUri(Context context, Uri uri) &#123;</span><br><span class="line">    if (uri == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    switch (uri.getScheme()) &#123;</span><br><span class="line">        case ContentResolver.SCHEME_CONTENT:</span><br><span class="line">            //Android7.0之后的uri content:// URI</span><br><span class="line">            return getFilePathFromContentUri(context, uri);</span><br><span class="line">        case ContentResolver.SCHEME_FILE:</span><br><span class="line">        default:</span><br><span class="line">            //Android7.0之前的uri file://</span><br><span class="line">            return new File(uri.getPath()).getAbsolutePath();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Android7.0之后的uri content:&#x2F;&#x2F; URI需要对微信、QQ等第三方APP做兼容</p>
</blockquote>
<ul>
<li>在文件管理选择本应用打开时,url的值为content:&#x2F;&#x2F;media&#x2F;external&#x2F;file&#x2F;85139  </li>
<li>在微信中选择本应用打开时,url的值为<br>content:&#x2F;&#x2F;com.tencent.mm.external.fileprovider&#x2F;external&#x2F;tencent&#x2F;MicroMsg&#x2F;Download&#x2F;111.doc  </li>
<li>在QQ中选择本应用打开时,url的值为<br>content:&#x2F;&#x2F;com.tencent.mobileqq.fileprovider&#x2F;external_files&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Tencent&#x2F;QQfile_recv&#x2F;</li>
</ul>
<blockquote>
<p>第一种为系统统一文件资源，能通过系统方法转化为绝对路径；<br>微信、QQ的为fileProvider，只能获取到文件流，需要先将文件copy到自己的私有目录。<br>方法如下：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 从uri获取path</span><br><span class="line"> *</span><br><span class="line"> * @param uri content://media/external/file/109009</span><br><span class="line"> *            &lt;p&gt;</span><br><span class="line"> *            FileProvider适配</span><br><span class="line"> *            content://com.tencent.mobileqq.fileprovider/external_files/storage/emulated/0/Tencent/QQfile_recv/</span><br><span class="line"> *            content://com.tencent.mm.external.fileprovider/external/tencent/MicroMsg/Download/</span><br><span class="line"> */</span><br><span class="line">private static String getFilePathFromContentUri(Context context, Uri uri) &#123;</span><br><span class="line">    if (null == uri) return null;</span><br><span class="line">    String data = null;</span><br><span class="line"></span><br><span class="line">    String[] filePathColumn = &#123;MediaStore.MediaColumns.DATA, MediaStore.MediaColumns.DISPLAY_NAME&#125;;</span><br><span class="line">    Cursor cursor = context.getContentResolver().query(uri, filePathColumn, null, null, null);</span><br><span class="line">    if (null != cursor) &#123;</span><br><span class="line">        if (cursor.moveToFirst()) &#123;</span><br><span class="line">            int index = cursor.getColumnIndex(MediaStore.MediaColumns.DATA);</span><br><span class="line">            if (index &gt; -1) &#123;</span><br><span class="line">                data = cursor.getString(index);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                int nameIndex = cursor.getColumnIndex(MediaStore.MediaColumns.DISPLAY_NAME);</span><br><span class="line">                String fileName = cursor.getString(nameIndex);</span><br><span class="line">                data = getPathFromInputStreamUri(context, uri, fileName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cursor.close();</span><br><span class="line">    &#125;</span><br><span class="line">    return data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 用流拷贝文件一份到自己APP私有目录下</span><br><span class="line"> *</span><br><span class="line"> * @param context</span><br><span class="line"> * @param uri</span><br><span class="line"> * @param fileName</span><br><span class="line"> */</span><br><span class="line">private static String getPathFromInputStreamUri(Context context, Uri uri, String fileName) &#123;</span><br><span class="line">    InputStream inputStream = null;</span><br><span class="line">    String filePath = null;</span><br><span class="line"></span><br><span class="line">    if (uri.getAuthority() != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            inputStream = context.getContentResolver().openInputStream(uri);</span><br><span class="line">            File file = createTemporalFileFrom(context, inputStream, fileName);</span><br><span class="line">            filePath = file.getPath();</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (inputStream != null) &#123;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return filePath;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static File createTemporalFileFrom(Context context, InputStream inputStream, String fileName)</span><br><span class="line">        throws IOException &#123;</span><br><span class="line">    File targetFile = null;</span><br><span class="line"></span><br><span class="line">    if (inputStream != null) &#123;</span><br><span class="line">        int read;</span><br><span class="line">        byte[] buffer = new byte[8 * 1024];</span><br><span class="line">        //自己定义拷贝文件路径</span><br><span class="line">        targetFile = new File(context.getExternalCacheDir(), fileName);</span><br><span class="line">        if (targetFile.exists()) &#123;</span><br><span class="line">            targetFile.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        OutputStream outputStream = new FileOutputStream(targetFile);</span><br><span class="line"></span><br><span class="line">        while ((read = inputStream.read(buffer)) != -1) &#123;</span><br><span class="line">            outputStream.write(buffer, 0, read);</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return targetFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2019/09/12/fragment%E5%B5%8C%E5%A5%97viewpagr-fragment%E4%BC%9A%E5%87%BA%E7%8E%B0%E7%99%BD%E5%B1%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/12/fragment%E5%B5%8C%E5%A5%97viewpagr-fragment%E4%BC%9A%E5%87%BA%E7%8E%B0%E7%99%BD%E5%B1%8F/" class="post-title-link" itemprop="url">fragment嵌套viewpagr+fragment会出现白屏</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-12 14:34:03" itemprop="dateCreated datePublished" datetime="2019-09-12T14:34:03+08:00">2019-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="getChildFragmentManager"><a href="#getChildFragmentManager" class="headerlink" title="getChildFragmentManager()"></a>getChildFragmentManager()</h2><p>有时候，我们会在 Fragment 里面继续嵌套二级甚至三级 Fragment，即 Activity 嵌套多级 Fragment。此时在 Fragment 里管理子 Fragment 时，也需要使用到 FragmentManager。但是一定要使用 v4.fragment.getChildFragmentManager() 方法获取 FragmentManager 对象！</p>
<h4 id="1-Fragment嵌套Fragment要用getChildFragmentManager。"><a href="#1-Fragment嵌套Fragment要用getChildFragmentManager。" class="headerlink" title="1.Fragment嵌套Fragment要用getChildFragmentManager。"></a>1.Fragment嵌套Fragment要用getChildFragmentManager。</h4><p>本来里面的fragment用的还是getFragmentManager,Fragment嵌套Fragment时，里面要用getChildFragmentManager。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FragmentManager</span> <span class="variable">childFragmentManager</span> <span class="operator">=</span> getChildFragmentManager();</span><br><span class="line">  <span class="type">ViewPager_Adapter</span> <span class="variable">viewPager_adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewPager_Adapter</span>(childFragmentManager, fragments);    <span class="comment">//FragmentPagerAdapter</span></span><br></pre></td></tr></table></figure>
<h4 id="2-常见错误-java-lang-IllegalStateException-Activity-has-been-destroyed"><a href="#2-常见错误-java-lang-IllegalStateException-Activity-has-been-destroyed" class="headerlink" title="2.常见错误  java.lang.IllegalStateException: Activity has been destroyed"></a>2.常见错误  java.lang.IllegalStateException: Activity has been destroyed</h4><p>onCreate中缺少super.onCreate(savedInstanceState) ，把它放在所有语句之前，应该解决这个问题。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2019/04/22/Android%E5%BA%94%E7%94%A8%E5%86%85%E6%82%AC%E6%B5%AE%E7%AA%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/22/Android%E5%BA%94%E7%94%A8%E5%86%85%E6%82%AC%E6%B5%AE%E7%AA%97/" class="post-title-link" itemprop="url">Android应用内悬浮窗</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-22 15:43:39" itemprop="dateCreated datePublished" datetime="2019-04-22T15:43:39+08:00">2019-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="应用内悬浮窗-自动贴边"><a href="#应用内悬浮窗-自动贴边" class="headerlink" title="应用内悬浮窗-自动贴边"></a>应用内悬浮窗-自动贴边</h2><blockquote>
<p>无需权限！！！<br>无需权限！！！<br>无需权限！！！</p>
</blockquote>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p><img src="/2019/04/22/Android%E5%BA%94%E7%94%A8%E5%86%85%E6%82%AC%E6%B5%AE%E7%AA%97/2019-02-16.gif"></p>
<blockquote>
<p>实现原理：获取当前activity的DecorView然后find到android.R.id.content，addView自己的view。</p>
</blockquote>
<p>获取当前activity的content</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private FrameLayout getActivityRoot(Activity activity) &#123;</span><br><span class="line">        if (activity == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (FrameLayout) activity.getWindow().getDecorView().findViewById(android.R.id.content);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h3><h4 id="FloatingManage"><a href="#FloatingManage" class="headerlink" title="FloatingManage"></a>FloatingManage</h4><blockquote>
<p>主要为悬浮窗的管理类，包括设置头像、弹出内容、显示与隐藏。</p>
</blockquote>
<h4 id="FloatRootView、FloatView"><a href="#FloatRootView、FloatView" class="headerlink" title="FloatRootView、FloatView"></a>FloatRootView、FloatView</h4><blockquote>
<p>主要为悬浮窗的页面布局和拖动、点按事件的监听操作的实现。</p>
</blockquote>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><blockquote>
<p>Demo已上传Github如需要可下载<a target="_blank" rel="noopener" href="https://github.com/wangtaoT/FloatingView">https://github.com/wangtaoT/FloatingView</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2018/05/18/Android%E5%A4%9A%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85-%E5%8F%98%E7%A7%8D%E6%89%93%E5%8C%85%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/18/Android%E5%A4%9A%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85-%E5%8F%98%E7%A7%8D%E6%89%93%E5%8C%85%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Android多渠道打包-变种打包配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-05-18 15:25:41" itemprop="dateCreated datePublished" datetime="2018-05-18T15:25:41+08:00">2018-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>通过productFlavor用来为app创建不同的版本，如：免费版和付费版、不同应用市场的渠道包等。</strong><br>创建方式：</p>
<h3 id="Gradle中配置"><a href="#Gradle中配置" class="headerlink" title="Gradle中配置"></a>Gradle中配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        nbsylzxVersion &#123;           //渠道1</span><br><span class="line">            applicationId &quot;com.wangtao.nbsylzx&quot;</span><br><span class="line">            manifestPlaceholders = [package_name        : &quot;com.wangtao.nbsylzx&quot;,</span><br><span class="line">                                    umeng_appkey        : &quot;5a1b7cb2f29d98&quot;,</span><br><span class="line">                                    umeng_message_secret: &quot;46b6a40c6a749f&quot;,</span><br><span class="line">                                    baiduMap_appKey     : &quot;MnaZOYCPOIqozGoSle&quot;]</span><br><span class="line">                versionCode 1</span><br><span class="line">                versionName &quot;V1.0.1&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        fhzyyVersion &#123;             //渠道2</span><br><span class="line">            applicationId &quot;com.wangtao.fhzyy&quot;</span><br><span class="line">            manifestPlaceholders = [package_name        : &quot;com.wangtao.fhzyy&quot;,</span><br><span class="line">                                    umeng_appkey        : &quot;59b8da5f734b&quot;,</span><br><span class="line">                                    umeng_message_secret: &quot;1b652c87cd9d&quot;,</span><br><span class="line">                                    baiduMap_appKey     : &quot;U0pNbvVRZHwTfP&quot;]</span><br><span class="line">            versionCode 2</span><br><span class="line">            versionName &quot;V1.0.2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过这种方式可以配置不同的包名、友盟key、百度key等。</p>
</blockquote>
<h3 id="AndroidManfest-xml中获取key"><a href="#AndroidManfest-xml中获取key" class="headerlink" title="AndroidManfest.xml中获取key"></a>AndroidManfest.xml中获取key</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--百度地图--&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;com.baidu.lbsapi.API_KEY&quot;</span><br><span class="line">    android:value=&quot;$&#123;baiduMap_appKey&#125;&quot; /&gt;</span><br><span class="line">&lt;!--友盟--&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;UMENG_APPKEY&quot;</span><br><span class="line">    android:value=&quot;$&#123;umeng_appkey&#125;&quot; /&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;UMENG_MESSAGE_SECRET&quot;</span><br><span class="line">    android:value=&quot;$&#123;umeng_message_secret&#125;&quot; /&gt;</span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;UMENG_CHANNEL&quot;</span><br><span class="line">    android:value=&quot;Umeng&quot; /&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过${名称}来获取gradle中的配置</p>
</blockquote>
<h3 id="创建对应文件夹"><a href="#创建对应文件夹" class="headerlink" title="创建对应文件夹"></a>创建对应文件夹</h3><ul>
<li><p>在app-src中创建与main同层级的文件夹</p>
</li>
<li><p>文件夹名称与productFlavors中配置的要一样</p>
<p> – main<br> – nbsylzxVersion<br> – fhzyyVersion</p>
</li>
<li><p>对应文件夹中也可以创建java&#x2F;res</p>
<p>  – main<br>  —–java<br>  —–res<br>  –nbsylzxVersion<br>  —–java<br>  —–res</p>
</li>
</ul>
<blockquote>
<p>main-java中的文件与变种文件夹中的.java文件不能重名<br>main-res中的资源文件与变种文件夹中的资源文件相同，优先使用变种文件夹资源文件</p>
</blockquote>
<h3 id="不同依赖配置"><a href="#不同依赖配置" class="headerlink" title="不同依赖配置"></a>不同依赖配置</h3><p>在Gradle中dependencies{}中配置依赖，渠道名称+Compile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies&#123;</span><br><span class="line">    nbsylzxVersionCompile project(&#x27;:baiduMap&#x27;)</span><br><span class="line">    fhzyyVersionCompile &#x27;com.github.bumptech.glide:glide:4.0.0&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解决友盟多包名无法推送问题问题"><a href="#解决友盟多包名无法推送问题问题" class="headerlink" title="解决友盟多包名无法推送问题问题"></a>解决友盟多包名无法推送问题问题</h3><p>如果：<br>productFlavors中多包名</p>
<ul>
<li>applicationId：com.test.a</li>
<li>applicationId：com.test.b</li>
<li>AndroidManfest.xml中<br> package&#x3D;”com.test.c”</li>
</ul>
<p>那么在Application中初始化友盟时增加以下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mPushAgent.setResourcePackageName(&quot;com.test.c&quot;);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2017/11/25/Android%E7%BC%96%E8%AF%91so%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/25/Android%E7%BC%96%E8%AF%91so%E5%BA%93/" class="post-title-link" itemprop="url">Android编译so库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-25 15:10:30" itemprop="dateCreated datePublished" datetime="2017-11-25T15:10:30+08:00">2017-11-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Android开发中很多时候需要使用第三方开源库，当它是用C++写的时就需要编译成SO库，本文就是编译之前需要做的准备！<br>配置NDK、SDK环境！<br>配置NDK、SDK环境！<br>配置NDK、SDK环境！</p>
<h3 id="搭建虚拟机"><a href="#搭建虚拟机" class="headerlink" title="搭建虚拟机"></a>搭建虚拟机</h3><p>我在这里选择VMware12虚拟机VMware Workstation Pro<a target="_blank" rel="noopener" href="https://www.vmware.com/cn.html">下载地址</a></p>
<h3 id="安装Linux系统"><a href="#安装Linux系统" class="headerlink" title="安装Linux系统"></a>安装Linux系统</h3><p>选择Ubuntu<a target="_blank" rel="noopener" href="http://www.ubuntu.org.cn/download/desktop">下载地址</a></p>
<h3 id="下载AndroidNDK及SDK"><a href="#下载AndroidNDK及SDK" class="headerlink" title="下载AndroidNDK及SDK"></a>下载AndroidNDK及SDK</h3><p>android NDK选择Linux版本。<a target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/downloads/index.html">下载地址</a><br>android SDK选择高一点的Linux版本。<a target="_blank" rel="noopener" href="http://tools.android-studio.org/index.php/sdk/">下载地址</a></p>
<blockquote>
<p>下载完成后在目录下会看到我们下载的ndk和sdk压缩包我们把它们解压出来，一个是.zip的另一个是.tgz的。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip xxx.zip</span><br><span class="line">tar zxvf xxx.taz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将两个压缩文件解压到当前目录即可。</p>
</blockquote>
<h3 id="下载openjdk"><a href="#下载openjdk" class="headerlink" title="下载openjdk"></a>下载openjdk</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install openjdk-8-jre-headless</span><br></pre></td></tr></table></figure>
<blockquote>
<p>会自动安装</p>
</blockquote>
<h3 id="配置SDK和NDK全局环境变量"><a href="#配置SDK和NDK全局环境变量" class="headerlink" title="配置SDK和NDK全局环境变量"></a>配置SDK和NDK全局环境变量</h3><p>下载的linux版本的SDK缺少一点东西，需要运行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /android-sdk-linux/tools/android</span><br></pre></td></tr></table></figure>
<p>下载最新的Android SDK Tools、Android SDK Platform-tools、Android SDK Build-tools、Android SDK Platform即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/profile</span><br></pre></td></tr></table></figure>

<p>在文件最后加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/你的路径/android-sdk-linux/platform-tools:$PATH</span><br><span class="line">export PATH=/你的路径/android-sdk-linux/tools:$PATH</span><br><span class="line">export ANDROID_NDK=/你的路径/android-ndk-r14b</span><br><span class="line">export PATH=/你的路径/android-ndk-r14b:$PATH</span><br></pre></td></tr></table></figure>
<blockquote>
<p>路径可能会有所不同！</p>
</blockquote>
<hr>
<p><strong>重启系统</strong>既可以生效</p>
<p><strong>接下来就可以编译你的ANdroid SO库了!!!</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wangtaot.github.io/2017/11/25/Android-OCR%E4%B9%8BTess-two/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangtao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wangtao's Blog">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Wangtao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/25/Android-OCR%E4%B9%8BTess-two/" class="post-title-link" itemprop="url">Android OCR之Tess-two</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-25 14:48:16" itemprop="dateCreated datePublished" datetime="2017-11-25T14:48:16+08:00">2017-11-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-12 10:12:13" itemprop="dateModified" datetime="2023-09-12T10:12:13+08:00">2023-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>实现小猿搜题、作业帮类似效果。<br>基于Google Tesseract-OCR实现，由于这是基于C++开发，Android中不能直接使用，所以本项目使用tess-two是对于Android的分支。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="1）Android-Studio导入gradle依赖（快速集成）"><a href="#1）Android-Studio导入gradle依赖（快速集成）" class="headerlink" title="1）Android Studio导入gradle依赖（快速集成）"></a>1）Android Studio导入gradle依赖（快速集成）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//编译好的SO库 和 jar包</span><br><span class="line">compile &#x27;com.rmtheis:tess-two:6.1.1&#x27;</span><br><span class="line">//图像裁剪</span><br><span class="line">compile &#x27;com.edmodo:cropper:1.0.1&#x27; </span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实也可以自己下载<a target="_blank" rel="noopener" href="https://github.com/rmtheis/tess-two">https://github.com/rmtheis/tess-two</a> 源码在Linux环境中进行编译。</p>
</blockquote>
<h3 id="2）第二种方法-自己编译源码（！！！）"><a href="#2）第二种方法-自己编译源码（！！！）" class="headerlink" title="2）第二种方法 自己编译源码（！！！）"></a>2）第二种方法 自己编译源码（！！！）</h3><ul>
<li>安装虚拟机VMware</li>
<li>安装linux系统Ubunt</li>
<li>安装必要工具</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure>
<ul>
<li>配置JDK、NDK、SDK环境（踩了一万个坑）<a href="https://wangtaot.github.io/2017/11/25/Android%E7%BC%96%E8%AF%91so%E5%BA%93/">具体教程地址</a></li>
<li>下载tess-two代码</li>
<li>开始编译(依次输入以下两行命令)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /tess/tess-two/jni</span><br><span class="line">ndk-build</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<br>将编译好的tess-two目录复制到自己项目的libraries下，将项目下的app关联 libraries。</li>
</ul>
<hr>
<h2 id="tess-two使用"><a href="#tess-two使用" class="headerlink" title="tess-two使用"></a>tess-two使用</h2><ul>
<li><p>数据字典下载，在app&#x2F;main目录下新建assets目录，从<a target="_blank" rel="noopener" href="https://github.com/tesseract-ocr/tessdata">https://github.com/tesseract-ocr/tessdata</a>  下载对应语言的字典库。</p>
</li>
<li><p>MainActivity.java</p>
</li>
</ul>
<blockquote>
<p>主要就是将assets中的字典文件写到手机文件目录</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 将assets中的文件复制出</span><br><span class="line"> *</span><br><span class="line"> * @param path</span><br><span class="line"> */</span><br><span class="line">public void deepFile(String path) &#123;</span><br><span class="line">    String newPath = getExternalFilesDir(null) + &quot;/&quot;;</span><br><span class="line">    try &#123;</span><br><span class="line">        String str[] = getAssets().list(path);</span><br><span class="line">        if (str.length &gt; 0) &#123;//如果是目录</span><br><span class="line">            File file = new File(newPath + path);</span><br><span class="line">            file.mkdirs();</span><br><span class="line">            for (String string : str) &#123;</span><br><span class="line">                path = path + &quot;/&quot; + string;</span><br><span class="line">                deepFile(path);</span><br><span class="line">                path = path.substring(0, path.lastIndexOf(&#x27;/&#x27;));//回到原来的path</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;//如果是文件</span><br><span class="line">            InputStream is = getAssets().open(path);</span><br><span class="line">            FileOutputStream fos = new FileOutputStream(new File(newPath + path));</span><br><span class="line">            byte[] buffer = new byte[1024];</span><br><span class="line">            int count = 0;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                count++;</span><br><span class="line">                int len = is.read(buffer);</span><br><span class="line">                if (len == -1) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                fos.write(buffer, 0, len);</span><br><span class="line">            &#125;</span><br><span class="line">            is.close();</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>点击跳转到拍照界面</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void onClick(View view) &#123;</span><br><span class="line">        switch (view.getId()) &#123;</span><br><span class="line">            case R.id.btn_camera:</span><br><span class="line">                Intent intent = new Intent(this, TakePhoteActivity.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>TakePhoteActivity.java 主要执行拍照、裁剪操作。</li>
</ul>
<blockquote>
<p>以下是拍照成功后回掉接口，拍照成功后显示剪裁界面</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 拍照成功后回调</span><br><span class="line">    * 存储图片并显示截图界面</span><br><span class="line">    *</span><br><span class="line">    * @param data</span><br><span class="line">    */</span><br><span class="line">   @Override</span><br><span class="line">   public void onCameraStopped(byte[] data) &#123;</span><br><span class="line">       Log.i(&quot;TAG&quot;, &quot;==onCameraStopped==&quot;);</span><br><span class="line">       // 创建图像</span><br><span class="line">       Bitmap bitmap = BitmapFactory.decodeByteArray(data, 0, data.length);</span><br><span class="line">       // 系统时间</span><br><span class="line">       long dateTaken = System.currentTimeMillis();</span><br><span class="line">       // 图像名称</span><br><span class="line">       String filename = DateFormat.format(&quot;yyyy-MM-dd kk.mm.ss&quot;, dateTaken).toString() + &quot;.jpg&quot;;</span><br><span class="line">       // 存储图像（PATH目录）</span><br><span class="line">       Uri source = insertImage(getContentResolver(), filename, dateTaken, PATH, filename, bitmap, data);</span><br><span class="line">       //准备截图</span><br><span class="line">       try &#123;</span><br><span class="line">           mCropImageView.setImageBitmap(MediaStore.Images.Media.getBitmap(this.getContentResolver(), source));</span><br><span class="line">       &#125; catch (IOException e) &#123;</span><br><span class="line">           Log.e(TAG, e.getMessage());</span><br><span class="line">       &#125;</span><br><span class="line">       showCropperLayout();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>剪裁操作，完成后跳转到识别界面</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private View.OnClickListener cropcper = new View.OnClickListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onClick(View view) &#123;</span><br><span class="line">            switch (view.getId()) &#123;</span><br><span class="line">                case R.id.btn_closecropper:</span><br><span class="line">                    showTakePhotoLayout();</span><br><span class="line">                    break;</span><br><span class="line">                case R.id.btn_startcropper:</span><br><span class="line">                    //获取截图并旋转90度</span><br><span class="line">                    Bitmap cropperBitmap = mCropImageView.getCroppedImage();</span><br><span class="line">                    Bitmap bitmap = Utils.rotate(cropperBitmap, -90);</span><br><span class="line">                    // 系统时间</span><br><span class="line">                    long dateTaken = System.currentTimeMillis();</span><br><span class="line">                    // 图像名称</span><br><span class="line">                    String filename = DateFormat.format(&quot;yyyy-MM-dd kk.mm.ss&quot;, dateTaken).toString() + &quot;.jpg&quot;;</span><br><span class="line">                    Uri uri = insertImage(getContentResolver(), filename, dateTaken, PATH, filename, bitmap, null);</span><br><span class="line">                    Intent intent = new Intent(TakePhoteActivity.this, ShowCropperedActivity.class);</span><br><span class="line">                    intent.setData(uri);</span><br><span class="line">                    intent.putExtra(&quot;path&quot;, PATH + filename);</span><br><span class="line">                    intent.putExtra(&quot;width&quot;, bitmap.getWidth());</span><br><span class="line">                    intent.putExtra(&quot;height&quot;, bitmap.getHeight());</span><br><span class="line">//                  intent.putExtra(&quot;cropperImage&quot;, bitmap);</span><br><span class="line">                    startActivity(intent);</span><br><span class="line">                    bitmap.recycle();</span><br><span class="line">                    finish();</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>ShowCropperedActivity.java 主要是识别操作</li>
</ul>
<blockquote>
<p>初始化识别器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//sd卡路径</span><br><span class="line">private static String LANGUAGE_PATH = &quot;&quot;;</span><br><span class="line">//识别语言</span><br><span class="line">private static final String LANGUAGE = &quot;chi_sim&quot;;//chi_sim | eng</span><br><span class="line">private TessBaseAPI baseApi = new TessBaseAPI();</span><br><span class="line">@Override</span><br><span class="line">protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">    LANGUAGE_PATH = getExternalFilesDir(&quot;&quot;) + &quot;/&quot;;</span><br><span class="line">    </span><br><span class="line">    baseApi.init(LANGUAGE_PATH, LANGUAGE);</span><br><span class="line">    //设置设别模式</span><br><span class="line">    baseApi.setPageSegMode(TessBaseAPI.PageSegMode.PSM_AUTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将图片灰度化处理，去除杂色可以提高准确度</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 灰度化处理</span><br><span class="line"> *</span><br><span class="line"> * @param bitmap3</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public Bitmap convertGray(Bitmap bitmap3) &#123;</span><br><span class="line">    colorMatrix = new ColorMatrix();</span><br><span class="line">    colorMatrix.setSaturation(0);</span><br><span class="line">    ColorMatrixColorFilter filter = new ColorMatrixColorFilter(colorMatrix);</span><br><span class="line">    Paint paint = new Paint();</span><br><span class="line">    paint.setColorFilter(filter);</span><br><span class="line">    Bitmap result = Bitmap.createBitmap(bitmap3.getWidth(), bitmap3.getHeight(), Bitmap.Config.ARGB_8888);</span><br><span class="line">    Canvas canvas = new Canvas(result);</span><br><span class="line">    canvas.drawBitmap(bitmap3, 0, 0, paint);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>开始识别</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//传入图片</span><br><span class="line">baseApi.setImage(bitmap);</span><br><span class="line">//获取识别后的结果</span><br><span class="line">String result = baseApi.getUTF8Text();</span><br><span class="line">//结束识别</span><br><span class="line">baseApi.end();</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>Demo已上传Github如需要可下载<a target="_blank" rel="noopener" href="https://github.com/wangtaoT/AndroidOCR">https://github.com/wangtaoT/AndroidOCR</a><br><img src="/2017/11/25/Android-OCR%E4%B9%8BTess-two/result.jpg"> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wangtao</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
